<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/touch-icon.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/touch-icon-iphone-retina.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/touch-icon-ipad-retina.png" />
<title>Elmätare Tilialacus</title>
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript">
$(function () {
	
    var gaugeChart = new Highcharts.Chart({
	
	    chart: {
	        renderTo: 'gauge-container',
	        type: 'gauge',
	        plotBackgroundColor: null,
	        plotBackgroundImage: null,
	        plotBorderWidth: 0,
	        plotShadow: false
	    },
	    
	    title: {
	        text: null
	    },
	    
		credits: {
	    	enabled: false
	    },
		
		exporting: {
			enabled: false			
		},
	    
	    pane: {
	        startAngle: -150,
	        endAngle: 150,
	        background: [{
	            backgroundColor: {
	                linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
	                stops: [
	                    [0, '#FFF'],
	                    [1, '#333']
	                ]
	            },
	            borderWidth: 0,
	            outerRadius: '109%'
	        }, {
	            backgroundColor: {
	                linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
	                stops: [
	                    [0, '#333'],
	                    [1, '#FFF']
	                ]
	            },
	            borderWidth: 1,
	            outerRadius: '107%'
	        }, {
	            // default background
	        }, {
	            backgroundColor: '#DDD',
	            borderWidth: 0,
	            outerRadius: '105%',
	            innerRadius: '103%'
	        }]
	    },
	       
	    // the value axis
	    yAxis: {
	        min: 0,
	        max: 10000,
	        
	        minorTickInterval: 'auto',
	        minorTickWidth: 1,
	        minorTickLength: 10,
	        minorTickPosition: 'inside',
	        minorTickColor: '#666',
	
			tickInterval: 1000,
	        tickPixelInterval: 30,
	        tickWidth: 2,
	        tickPosition: 'inside',
	        tickLength: 10,
	        tickColor: '#666',
	        labels: {
	            step: 2,
	            rotation: 'auto',
				formatter: function() { return this.value / 1000 + 'K' }
	        },
	        title: {
	            text: 'Watt'
	        },
	        plotBands: [{
	            from: 0,
	            to: 1000,
	            color: '#55BF3B' // green
	        }, {
	            from: 1000,
	            to: 5000,
	            color: '#DDDF0D' // yellow
	        }, {
	            from: 5000,
	            to: 10000,
	            color: '#DF5353' // red
	        }]        
	    },
	
	    series: [{
	        name: 'Förbrukning',
	        data: [0],
	        tooltip: {
	            valueSuffix: ' W'
	        }
	    }],
		
		plotOptions: {
			gauge: {
				dataLabels: {
					borderWidth: 0,
					format: '{y} W'
				}
			}
		}	
	}); 

    var historyChart = new Highcharts.Chart({
	
	    chart: {
	        renderTo: 'history-container',
	        type: 'line',
	        plotBackgroundColor: null,
	        plotBackgroundImage: null,
	        plotBorderWidth: 0,
	        plotShadow: false
	    },
		title: {
			text: "Historisk"
		},
		legend: {
			enabled: false
		},
        series: [{
            data: [[Date.now(), 0]],
			name: "Förbrukning"
        }],
		xAxis: {
		            type: 'datetime'
		},
		yAxis: {
			min: 0,
			max: 10000,
			tickInterval: 1000,
	        labels: {
	            step: 2,
				formatter: function() { return this.value / 1000 + 'K' }
	        },
			title: {
				text: null
			}
		},
		credits: {
	    	enabled: false
	    },
		exporting: {
			enabled: false			
		}

	});

	var f = function(gaugeChart, historyChart) {
		  var socket = io.connect(window.location.href);
		  
		  socket.on('connect', function () {
		    socket.emit('power-id', '1234');
		  });

		  socket.on('setup', function(data) {
			  var val = Math.floor(data.value * 1000);
		      var point = gaugeChart.series[0].points[0];
		      point.update(val);
			  var time = Date.now() - 5000 * (data.history.length - 1);
			  for (var i = 0, len = data.history.length; i < len; i++) {
				  historyChart.series[0].addPoint([time, Math.floor(data.history[i] * 1000)], true, false);
				  time += 5000;
			  }
		  });
		  
		  socket.on('power', function(data) {
		      var point = gaugeChart.series[0].points[0];
			  var val = Math.floor(data.value * 1000);
		      point.update(val);
			  
			  historyChart.series[0].addPoint([Date.now(), val], true, true);
		  });
	};
	
	f(gaugeChart, historyChart);
});
</script>
</head>
<body>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<script src="http://code.highcharts.com/highcharts-more.js"></script>
	<div class="page-header">
	  <h1>Elmätare <small>Tilialacus</small></h1>
	</div>
	<ul class="nav nav-tabs" id="tabs">
		<li class="active"><a href="#instant" data-toggle="tab">Just nu</a></li>
		<li><a href="#history" data-toggle="tab">Historisk</a></li>
	</ul>
	<div class="tab-content">
  	  <div class="tab-pane fade in active" id="instant">
	  	<div class="row">		
	  		<div id="gauge-container" class="span12"></div>
	  	</div>
  	  </div>
	  <div class="tab-pane fade in" id="history">
	  	<div class="row">		
	  		<div id="history-container" class="span12"></div>
	  	</div >
	  </div>
	</div>
	<script>
	$('#tabs a').click(function (e) {
	  e.preventDefault();
	  $(this).tab('show');
	})
	</script>
</body>
</html>
